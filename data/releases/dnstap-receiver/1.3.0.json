{
  "info": {
    "author": "Denis MACHARD",
    "author_email": "d.machard@gmail.com",
    "bugtrack_url": null,
    "classifiers": [
      "License :: OSI Approved :: MIT License",
      "Operating System :: OS Independent",
      "Programming Language :: Python :: 3",
      "Topic :: Software Development :: Libraries"
    ],
    "description": "# Dnstap streams receiver\n\n![Pypi](https://github.com/dmachard/dnstap_receiver/workflows/Publish%20to%20PyPI/badge.svg) ![Build](https://github.com/dmachard/dnsdist-console/workflows/Build/badge.svg) ![Testing](https://github.com/dmachard/dnstap_receiver/workflows/Testing/badge.svg) \n\n[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)\n![PyPI - Python Version](https://img.shields.io/pypi/pyversions/dnstap_receiver)\n\nThis Python module acts as a DNS tap streams receiver for DNS servers.\nInput streams can be a unix socket or multiple remote dns servers.\nThe output is printed directly to stdout or send to remote tcp address \nin JSON, YAML or one line text format. \n\n## Table of contents\n* [Installation](#installation)\n* [Start dnstap receiver](#start-dnstap-receiver)\n* [Inputs handler](#inputs-handler)\n    * [TCP socket](#tcp-socket)\n    * [Unix socket](#unix-socket)\n* [Outputs handler](#outputs-handler)\n    * [Stdout](#stdout)\n    * [TCP socket](#tcp-socket)\n    * [Syslog](#syslog)\n    * [Metrics](#metrics)\n* [More options](#more-options)\n    * [External config file](#external-config-file)\n    * [Verbose mode](#verbose-mode)\n    * [Filtering feature](#filtering-feature)\n* [Tested DNS servers](#tested-dns-servers)\n    * [ISC - bind](#bind)\n    * [PowerDNS - pdns-recursor](#pdns-recursor)\n    * [PowerDNS - dnsdist](#dnsdist)\n    * [NLnet Labs - nsd](#nsd)\n    * [NLnet Labs - unbound](#unbound)\n* [Tested Logs Collectors](#tested-logs-collectors)\n    * [Rsyslog](#rsyslog)\n    * [Logstash](#logstash)\n* [Systemd service file configuration](#systemd-service-file-configuration)\n* [About](#about)\n\n## Installation\n\nDeploy the dnstap receiver in your DNS server with the pip command.\n\n```python\npip install dnstap_receiver\n```\n\n## Start dnstap receiver\n\nAfter installation, you can execute the `dnstap_receiver` to start-it.\n\nUsage:\n\n```\nusage: dnstap_receiver [-h] [-l L] [-p P] [-u U] [-v] [-c C]\n\noptional arguments:\n  -h, --help  show this help message and exit\n  -l L        IP of the dnsptap server to receive dnstap payloads (default: '0.0.0.0')\n  -p P        Port the dnstap receiver is listening on (default: 6000)\n  -u U        read dnstap payloads from unix socket\n  -v          verbose mode\n  -c C        external config file\n```\n\n\n## Inputs handler\n\nSeverals inputs handler are supported to read incoming dnstap messages:\n- TCP socket\n- Unix socket\n\n### TCP socket\n\nThe TCP socket input enable to receive dnstap messages from multiple dns servers.\nThis is the default input if you exectute the binary without arguments.\nThe receiver is listening on `localhost` interface and the tcp port `6000`.\nYou can change binding options with `-l` and `-p` arguments.\n\n```\n./dnstap_receiver -l 0.0.0.0 -p 6000\n```\n\nYou can also activate `TLS` on the socket, add the following config as external config file\nto activate the tls support, configure the path of the certificate and key to use.\n\n```yaml\ninput:\n  tcp-socket:\n    # enable tls support\n    tls-support: true\n    # provide certificate server path\n    tls-server-cert: /etc/dnstap_receiver/server.crt\n    # provide certificate key path\n    tls-server-key: /etc/dnstap_receiver/server.key\n```\n\nThen execute the dnstap receiver with the configuration file:\n\n```\n./dnstap_receiver -c /etc/dnstap-receiver/dnstap.conf\n```\n\n### Unix socket\n\nThe unix socket input enables read dnstap message from a unix socket. \nConfigure the path of the socket with the `-u` argument.\n\n```\n./dnstap_receiver -u /var/run/dnstap.sock\n```\n\n## Outputs handler\n\nOutputs handler can be configured to forward messages in several modes.\n- stdout\n- remote tcp socket\n- syslog\n\n### Stdout\n\nThis output enables to forward dnstap messages directly to Stdout.\nAdd the following configuration as external config to activate this output:\n\n```yaml\noutput:\n  stdout:\n    # format available text|json|yaml\n    format: text\n```\n\nOutput can be formatted in different way:\n- text (default one)\n- json \n- yaml\n\nText format:\n\n```\n2020-09-16T18:51:53.547352+00:00 centos RESOLVER_QUERY NOERROR - - IP4 UDP 43b ns2.google.com. A\n2020-09-16T18:51:53.591736+00:00 centos RESOLVER_RESPONSE NOERROR - - IP4 UDP 59b ns2.google.com. A\n```\n\nJSON format:\n\n```json\n{\n    \"identity\": \"dev-centos8\",\n    \"query-name\": \"www.google.com.\",\n    \"query-type\": \"A\",\n    \"source-ip\": \"192.168.1.114\",\n    \"message\": \"CLIENT_QUERY\",\n    \"protocol\": \"IP4\",\n    \"transport\": \"UDP\",\n    \"source-port\": 42222,\n    \"length\": 43,\n    \"timestamp\": \"2020-09-12 22:24:34.132\",\n    \"code\": \"NOERROR\"\n}\n```\n\nYAML format:\n\n```yaml\ncode: NOERROR\nlength: 49\nmessage: RESOLVER_QUERY\nprotocol: IP4\nquery-name: dns4.comlaude-dns.eu.\nquery-type: AAAA\nsource-ip: '-'\nsource-port: '-'\ntimestamp: '2020-09-12 14:13:53.948'\ntransport: UDP\n\n```\n\n### TCP socket\n\nThis output enables to forward dnstap message to a remote tcp collector\nAdd the following configuration as external config to activate this output:\n\n```yaml\noutput:\n  # forward to remote tcp destination\n  tcp-socket:\n    # enable or disable\n    enable: true\n    # format available text|json|yaml\n    format: text\n    # delimiter\n    delimiter: \"\\n\"\n    # retry interval in seconds to connect\n    retry: 5\n    # remote ipv4 or ipv6 address\n    remote-address: 10.0.0.2\n    # remote tcp port\n    remote-port: 8192\n```\n\n### Syslog\n\nThis output enables to forward dnstap message to a syslog server.\nAdd the following configuration as external config to activate this output:\n\n\n```yaml\noutput:\n  syslog:\n    # enable or disable\n    enable: false\n    # syslog over tcp or udp\n    transport: udp\n    # format available text|json\n    format: text\n    # retry interval in seconds to connect\n    retry: 5\n    # remote ipv4 or ipv6 address of the syslog server\n    remote-address: 10.0.0.2\n    # remote port of the syslog server\n    remote-port: 514\n```\n\nExample of output on syslog server\n\n```\nSep 22 12:43:01 bind CLIENT_RESPONSE NOERROR 192.168.1.100 51717 IP4 UDP 173b www.netflix.fr. A\nSep 22 12:43:01 bind CLIENT_RESPONSE NOERROR 192.168.1.100 51718 IP4 UDP 203b www.netflix.fr. AAAA\n```\n\n### Metrics\n\nThis output enables to generate metrics and print to stdout.\nAdd the following configuration as external config to activate this output:\n\n```yaml\noutput:\n  metrics:\n    # enable or disable\n    enable: true\n    # print every N seconds.\n    interval: 300\n    # cumulative statistics, without clearing them after printing\n    cumulative: false\n```\n\nExample of output\n\n```\n2020-10-13 05:19:35,522 18 QUERIES, 3.6 QPS, 1 CLIENTS, 18 IP4, 0 IP6, \n18 UDP, 0 TCP, 17 NOERROR, 1 NXDOMAIN, 18 A, 0 AAAA\n```\n\n## More options\n\n### External config file\n\nThe `dnstap_receiver` binary can takes an external config file with the `-c` argument\nSee [config file](https://github.com/dmachard/dnstap-receiver/blob/master/dnstap_receiver/dnstap.conf) example.\n\n```\n./dnstap_receiver -c /etc/dnstap-receiver/dnstap.conf\n```\n\n### Verbose mode\n\nYou can execute the binary in verbose mode with the `-v` argument:\n\n```\n./dnstap_receiver -v\n2020-09-12 23:47:35,833 Start dnstap receiver...\n2020-09-12 23:47:35,833 Using selector: EpollSelector\n2020-09-12 23:47:35,834 Listening on 0.0.0.0:6000\n```\n\n### Filtering feature\n\nThis feature can be useful if you want to ignore some messages and keep just what you want.\nSeveral filter are available:\n- by qname field\n- by dnstap identity field.\n\n#### By dnstap identity\n\nYou can filtering incoming dnstap messages according to the dnstap identity field.\nA regex can be configured in the external configuration file to do that\n\n```yaml\nfilter:\n  # dnstap identify filtering feature with regex support\n  dnstap-identities: dnsdist01|unbound01\n```\n\n#### By qname\n\nYou can filtering incoming dnstap messages according to the query name.\nA regex can be configured in the external configuration file to do that\n\n```yaml\nfilter: \n  # qname filtering feature with regex support\n  qname-regex: \".*.com\"\n```\n\n## Tested DNS servers\n\nThis dnstap receiver has been tested with success with the following dns servers:\n - **ISC - bind**\n - **PowerDNS - dnsdist, pdns-recursor**\n - **NLnet Labs - nsd, unbound**\n\n### bind\n\n![pdns-recursor 9.11.22](https://img.shields.io/badge/9.11.22-tested-green)\n\nDnstap messages supported:\n - RESOLVER_QUERY\n - RESOLVER_RESPONSE\n - CLIENT_QUERY\n - CLIENT_RESPONSE\n - AUTH_QUERY\n - AUTH_RESPONSE\n\n#### Build with dnstap support\n\nDownload latest source and build-it with dnstap support:\n\n```bash\n./configure --enable-dnstap\nmake && make install\n```\n\n#### Unix socket\n\nUpdate the configuration file `/etc/named.conf` to activate the dnstap feature:\n\n```\noptions {\n    dnstap { client; auth; resolver; forwarder; };\n    dnstap-output unix \"/var/run/named/dnstap.sock\";\n    dnstap-identity \"dns-bind\";\n    dnstap-version \"bind\";\n}\n```\n\nExecute the dnstap receiver with `named` user:\n\n```bash\nsu - named -s /bin/bash -c \"dnstap_receiver -u \"/var/run/named/dnstap.sock\"\"\n```\n\n### pdns-recursor\n\n![pdns-recursor 4.3.4](https://img.shields.io/badge/4.3.4-tested-green)\n\nDnstap messages supported:\n - RESOLVER_QUERY\n - RESOLVER_RESPONSE\n\n#### Unix socket\n\nUpdate the configuration file to activate the dnstap feature:\n\n```\nvim /etc/pdns-recursor/recursor.conf\nlua-config-file=/etc/pdns-recursor/recursor.lua\n\nvim /etc/pdns-recursor/recursor.lua\ndnstapFrameStreamServer(\"/var/run/pdns-recursor/dnstap.sock\")\n```\n\nExecute the dnstap receiver with `pdns-recursor` user:\n\n```bash\nsu - pdns-recursor -s /bin/bash -c \"dnstap_receiver -u \"/var/run/pdns-recursor/dnstap.sock\"\"\n```\n\n#### TCP stream\n\n\nUpdate the configuration file to activate the dnstap feature with tcp mode \nand execute the dnstap receiver in listening tcp socket mode:\n\n```\nvim /etc/pdns-recursor/recursor.conf\nlua-config-file=/etc/pdns-recursor/recursor.lua\n\nvim /etc/pdns-recursor/recursor.lua\ndnstapFrameStreamServer(\"10.0.0.100:6000\")\n```\n\n### dnsdist\n\n![dnsdist 1.4.0](https://img.shields.io/badge/1.4.0-tested-green) ![dnsdist 1.5.0](https://img.shields.io/badge/1.5.0-tested-green)\n\nDnstap messages supported:\n - CLIENT_QUERY\n - CLIENT_RESPONSE\n\n#### Unix socket\n\nCreate the dnsdist folder where the unix socket will be created:\n\n```bash\nmkdir -p /var/run/dnsdist/\nchown dnsdist.dnsdist /var/run/dnsdist/\n```\n\nUpdate the configuration file `/etc/dnsdist/dnsdist.conf` to activate the dnstap feature:\n\n```\nfsul = newFrameStreamUnixLogger(\"/var/run/dnsdist/dnstap.sock\")\naddAction(AllRule(), DnstapLogAction(\"dnsdist\", fsul))\naddResponseAction(AllRule(), DnstapLogResponseAction(\"dnsdist\", fsul))\n```\n\nExecute the dnstap receiver with `dnsdist` user:\n\n```bash\nsu - dnsdist -s /bin/bash -c \"dnstap_receiver -u \"/var/run/dnsdist/dnstap.sock\"\"\n```\n\n#### TCP stream\n\nUpdate the configuration file `/etc/dnsdist/dnsdist.conf` to activate the dnstap feature\nwith tcp stream and execute the dnstap receiver in listening tcp socket mode:\n\n```\nfsul = newFrameStreamTcpLogger(\"127.0.0.1:8888\")\naddAction(AllRule(), DnstapLogAction(\"dnsdist\", fsul))\naddResponseAction(AllRule(), DnstapLogResponseAction(\"dnsdist\", fsul))\n```\n\n### nsd\n\n![nsd 4.3.2](https://img.shields.io/badge/4.3.2-tested-green)\n\nDnstap messages supported:\n - AUTH_QUERY\n - AUTH_RESPONSE\n\n#### Build with dnstap support\n\nDownload latest source and build-it with dnstap support:\n\n```bash\n./configure --enable-dnstap\nmake && make install\n```\n\n#### Unix socket\n\nUpdate the configuration file `/etc/nsd/nsd.conf` to activate the dnstap feature:\n\n```yaml\ndnstap:\n    dnstap-enable: yes\n    dnstap-socket-path: \"/var/run/nsd/dnstap.sock\"\n    dnstap-send-identity: yes\n    dnstap-send-version: yes\n    dnstap-log-auth-query-messages: yes\n    dnstap-log-auth-response-messages: yes\n```\n\nExecute the dnstap receiver with `nsd` user:\n\n```bash\nsu - nsd -s /bin/bash -c \"dnstap_receiver -u \"/var/run/nsd/dnstap.sock\"\"\n```\n\n\n### unbound\n\n![unbound 1.11.0](https://img.shields.io/badge/1.11.0-tested-green) ![unbound 1.12.0](https://img.shields.io/badge/1.12.0-tested-green)\n\n\nDnstap messages supported:\n - CLIENT_QUERY\n - CLIENT_RESPONSE\n - RESOLVER_QUERY\n - RESOLVER_RESPONSE\n - CLIENT_QUERY\n - CLIENT_RESPONSE\n\n#### Build with dnstap support\n\nDownload latest source and build-it with dnstap support:\n\n```bash\n./configure --enable-dnstap\nmake && make install\n```\n\n#### Unix socket\n\nUpdate the configuration file `/etc/unbound/unbound.conf` to activate the dnstap feature:\n\n```yaml\ndnstap:\n    dnstap-enable: yes\n    dnstap-socket-path: \"dnstap.sock\"\n    dnstap-send-identity: yes\n    dnstap-send-version: yes\n    dnstap-log-resolver-query-messages: yes\n    dnstap-log-resolver-response-messages: yes\n    dnstap-log-client-query-messages: yes\n    dnstap-log-client-response-messages: yes\n    dnstap-log-forwarder-query-messages: yes\n    dnstap-log-forwarder-response-messages: yes\n```\n\nExecute the dnstap receiver with `unbound` user:\n\n```bash\nsu - unbound -s /bin/bash -c \"dnstap_receiver -u \"/usr/local/etc/unbound/dnstap.sock\"\"\n```\n\n#### TCP stream\n\nUpdate the configuration file `/etc/unbound/unbound.conf` to activate the dnstap feature \nwith tcp mode and execute the dnstap receiver in listening tcp socket mode:\n\n```yaml\ndnstap:\n    dnstap-enable: yes\n    dnstap-socket-path: \"\"\n    dnstap-ip: \"10.0.0.100@6000\"\n    dnstap-tls: no\n    dnstap-send-identity: yes\n    dnstap-send-version: yes\n    dnstap-log-client-query-messages: yes\n    dnstap-log-client-response-messages: yes\n```\n\n#### TLS stream\n\nUpdate the configuration file `/etc/unbound/unbound.conf` to activate the dnstap feature \nwith tls mode and execute the dnstap receiver in listening tcp/tls socket mode:\n\n```yaml\ndnstap:\n    dnstap-enable: yes\n    dnstap-socket-path: \"\"\n    dnstap-ip: \"10.0.0.100@6000\"\n    dnstap-tls: yes\n    dnstap-send-identity: yes\n    dnstap-send-version: yes\n    dnstap-log-client-query-messages: yes\n    dnstap-log-client-response-messages: yes\n```\n\n\n## Tested Logs Collectors\n\n### Rsyslog\n\nEdit the config file `/etc/rsyslog.conf` to activate tcp mode \n\n```\nmodule(load=\"imtcp\")\ninput(type=\"imtcp\" port=\"514\")\n```\n\n### Logstash\n\nEdit the file /etc/logstash/conf.d/00-dnstap.conf\n\n```\ninput {\n  tcp {\n      port => 6000\n      codec => json\n  }\n}\n\nfilter {\n  date {\n     match => [ \"dt_query\" , \"yyyy-MM-dd HH:mm:ss.SSS\" ]\n     target => \"@timestamp\"\n  }\n}\n\noutput {\n   elasticsearch {\n    hosts => [\"http://localhost:9200\"]\n    index => \"dnstap-lb\"\n  }\n}\n```\n\n## Systemd service file\n\nSystemd service file\n\nCreate the file /etc/systemd/system/dnstap_receiver.service\n\n```bash\n[Unit]\nDescription=Python DNS tap Service\nAfter=network.target\n\n[Service]\nExecStart=/usr/local/bin/dnstap_receiver -c /etc/dnstap_receiver/dnstap.conf\nRestart=on-abort\nType=simple\nUser=root\n\n[Install]\nWantedBy=multi-user.target\n```\n\n```bash\nsystemctl daemon-reload\nsystemctl start dnstap_receiver\nsystemctl status dnstap_receiver\nsystemctl enable dnstap_receiver\n```\n\n# About\n\n| | |\n| ------------- | ------------- |\n| Author |  Denis Machard <d.machard@gmail.com> |\n| License |  MIT | \n| PyPI |  https://pypi.org/project/dnstap_receiver/ |\n| | |\n\n\n",
    "description_content_type": "text/markdown",
    "docs_url": null,
    "download_url": "",
    "downloads": {
      "last_day": -1,
      "last_month": -1,
      "last_week": -1
    },
    "home_page": "https://github.com/dmachard/dnstap_receiver",
    "keywords": "dnstap receiver client json yaml text",
    "license": "",
    "maintainer": "",
    "maintainer_email": "",
    "name": "dnstap-receiver",
    "package_url": "https://pypi.org/project/dnstap-receiver/",
    "platform": "any",
    "project_url": "https://pypi.org/project/dnstap-receiver/",
    "project_urls": {
      "Homepage": "https://github.com/dmachard/dnstap_receiver"
    },
    "release_url": "https://pypi.org/project/dnstap-receiver/1.3.0/",
    "requires_dist": [
      "dnslib",
      "protobuf",
      "pyyaml"
    ],
    "requires_python": "",
    "summary": "Python Dnstap receiver",
    "version": "1.3.0",
    "yanked": false,
    "yanked_reason": null
  },
  "last_serial": 15714027,
  "urls": [
    {
      "comment_text": "",
      "digests": {
        "blake2b_256": "3fa72eabbeb9f1fcb8dbe5e773b2df96795fd53225ac4ca2aa4feade44a8f911",
        "md5": "9d775640aa32007a1c43135f08d7c220",
        "sha256": "9573fcc20d6b693136469e57420c56869d87105c3b15ae5b3df3078fcde4644e"
      },
      "downloads": -1,
      "filename": "dnstap_receiver-1.3.0-py3-none-any.whl",
      "has_sig": false,
      "md5_digest": "9d775640aa32007a1c43135f08d7c220",
      "packagetype": "bdist_wheel",
      "python_version": "py3",
      "requires_python": null,
      "size": 18272,
      "upload_time": "2020-10-14T06:32:17",
      "upload_time_iso_8601": "2020-10-14T06:32:17.795920Z",
      "url": "https://files.pythonhosted.org/packages/3f/a7/2eabbeb9f1fcb8dbe5e773b2df96795fd53225ac4ca2aa4feade44a8f911/dnstap_receiver-1.3.0-py3-none-any.whl",
      "yanked": false,
      "yanked_reason": null
    },
    {
      "comment_text": "",
      "digests": {
        "blake2b_256": "2d5a2deadbcd9dd49b780a877016ef06b08ee639b92e8d8d77f96a8833f9893f",
        "md5": "e2d117bd4df308a52f0d721536a94871",
        "sha256": "f54cdf989c13c6addeb38303993b04349b12a0c6db7124a2b23512a117af320a"
      },
      "downloads": -1,
      "filename": "dnstap_receiver-1.3.0.tar.gz",
      "has_sig": false,
      "md5_digest": "e2d117bd4df308a52f0d721536a94871",
      "packagetype": "sdist",
      "python_version": "source",
      "requires_python": null,
      "size": 19436,
      "upload_time": "2020-10-14T06:32:19",
      "upload_time_iso_8601": "2020-10-14T06:32:19.330663Z",
      "url": "https://files.pythonhosted.org/packages/2d/5a/2deadbcd9dd49b780a877016ef06b08ee639b92e8d8d77f96a8833f9893f/dnstap_receiver-1.3.0.tar.gz",
      "yanked": false,
      "yanked_reason": null
    }
  ],
  "vulnerabilities": []
}